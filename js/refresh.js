const ARTIST = 0;
const GENRE = 1;
const SONGX = 0;
const SONGY = 1;

const trackChange = function () {
  getSongCount();
  isPlayerStoppedPaused();
  getNextTanda();
  isInterstitial();
  afterCumparsita();
  getNowPlayingNew();
};

// External script: get the name, artist, genre of current song
function getNowPlayingNew() {
  applescript.execFile((store.get('player')) + "nowPlayingInfo.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn) {
      document.getElementById("nowPlayingArtist").innerHTML = rtn[1] ;
      document.getElementById("nowPlayingGenre").innerHTML = rtn[2] ;

      // Write the title to the announcement div in case it's an announcement
      document.getElementById("announcementText").innerHTML = rtn[0] ;

      // Look backwards through rtn and add a <br> before the final ( if there is one
      let finalOpenParenPosition = rtn[0].lastIndexOf('(');
      if (finalOpenParenPosition > -1) {
              let modifiedForParen = rtn[0].substring(0, finalOpenParenPosition) + '<br/> (' + rtn[0].substring(finalOpenParenPosition + 1);
              document.getElementById("nowPlayingName").innerHTML = modifiedForParen ;
      }
      else {
        document.getElementById("nowPlayingName").innerHTML = rtn[0] ;
      }
    }
  });
}


// External script: Get array with next-tanda artist and genre, and write to both cortina and nextTanda divs
function getNextTanda() {
  applescript.execFile((store.get('player')) + "getNextTanda.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn) {
      // Check if anonymizeAlt is true and look at the grouping
      if (store.get('anonymizeAlt') == "true" && rtn[2].match("#nu") ) {
        rtn[0] = "Alternative";
      }

      document.getElementById("cortinaNextTandaArtist").innerHTML = rtn[ARTIST];
      document.getElementById("cortinaNextTandaGenre").innerHTML = rtn[GENRE];

      // Write to the nextTanda div, with text appends as needed
      if (rtn[ARTIST].length >0) {
        document.getElementById("nextTandaArtist").innerHTML = ("<strong>NEXT TANDA:</strong> " + rtn[ARTIST]);
      }
      else {
        document.getElementById("nextTandaArtist").innerHTML = rtn[ARTIST];
      }
      if (rtn[GENRE].length >0 && !rtn[GENRE].match("Last Tanda") )  {
        document.getElementById("nextTandaGenre").innerHTML = ("&nbsp;&nbsp;|&nbsp;&nbsp;" + rtn[GENRE]);
      }
      else {
        document.getElementById("nextTandaGenre").innerHTML = rtn[GENRE];
      }
    }
  });
}

// External AppleScript: Get array with X of Y count of current tanda
function getSongCount() {
  applescript.execFile((store.get('player')) + "getSongCount.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn[SONGX] > 0 && rtn[SONGY] > 0) { // This prevents visual skip for negative numbers generated by cortinas
      document.getElementById("songX").innerHTML = rtn[SONGX];
      document.getElementById("songY").innerHTML = rtn[SONGY];
    }
  });
}

// External script: Display image in overlay if player state is stopped or paused
function isPlayerStoppedPaused() {
  applescript.execFile((store.get('player')) + "isPlayerStoppedPaused.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn !== "playing")  {
      document.getElementById("playerStoppedPaused").style.display = "block";
    }
    else {
      document.getElementById("playerStoppedPaused").style.display = "none";
    }
  });
}

// External AppleScript: Detect interstitial; if so, display either next-tanda or announcement info and hide nowNext
function isInterstitial() {
  applescript.execFile((store.get('player')) + "detectInterstitial.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn[0].match("ortina"))  {
      document.getElementById("interstitial").style.display = "flex";
      document.getElementById("cortina").style.display = "block";
      document.getElementById("announcement").style.display = "none";
      document.getElementById("nowNext").style.display = "none";
    }
    if (rtn[1].match("nnounc"))  {
      document.getElementById("interstitial").style.display = "flex";
      document.getElementById("cortina").style.display = "none";
      document.getElementById("announcement").style.display = "block";
      document.getElementById("nowNext").style.display = "none";
    }
    if (!rtn[1].match("nnounc") && !rtn[0].match("ortina")) {
      document.getElementById("interstitial").style.display = "none";
      document.getElementById("cortina").style.display = "none";
      document.getElementById("announcement").style.display = "none";
      document.getElementById("nowNext").style.display = "block";
    }
  });

}

// External AppleScript: Display thanks announcement if any of last 10 track names contains "umparsita"
function afterCumparsita() {
  applescript.execFile((store.get('player')) + "afterCumparsita.applescript", function(err, rtn) {
    if (err) {return}
    if (rtn == "yes")  {
      document.getElementById("afterCumparsita").style.display = "flex";
    }
    else {
      document.getElementById("afterCumparsita").style.display = "none";
    }
  });
}
